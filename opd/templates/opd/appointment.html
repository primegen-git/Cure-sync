{% extends 'opd/index.html' %}
{% load static %}

{% block css %}
<link rel="stylesheet" href="{% static 'styles/opd_appointment.css' %}" />
{% endblock css %}

{% block content %}
    {% if request_count != 0 %}
    <div class="notification">
        <i class="icon fas fa-bell"></i>
        <p><strong>New Online Booking!</strong> You have {{request_count}} new appointment requests.</p>
        <a href="{% url 'opd:appointment_request' %}" class="btn btn-secondary">View Requests</a>
    </div>
    {% endif %}

    <div class="page-header">
        <div class="header-main">
            <h1>Appointments</h1>
        </div>
        <div class="header-actions">
            <div class="search-form">
                <input type="text" id="searchInput" placeholder="Search by patient..." />
                <button class="btn-search"><i class="fas fa-search"></i></button>
            </div>
            <a href="{% url 'opd:offline_appointment_booking' %}" class="btn btn-primary">
                <i class="fas fa-plus"></i> Add Appointment
            </a>
        </div>
    </div>

    <div class="stats-grid">
         <div class="stat-card">
            <h3 class="card-title">Total Appointments</h3>
            <p class="stat-value">{{total_appointment}}</p>
        </div>
        <div class="stat-card">
            <h3 class="card-title">Online Requests</h3>
            <p class="stat-value">{{request_count}}</p>
        </div>
    </div>

    <div class="card table-card">
        <div class="table-wrapper">
            <table class="data-table">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Patient Name</th>
                    <th>Date & Time</th>
                    <th>Mode</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for appointment in appointments %}
                  <tr>
                    <td>{{appointment.appointment_id}}</td>
                    <td>{{appointment.name}}</td>
                    <td>{{ appointment.appointment_date|date:"M d, Y, h:i A" }}</td>
                    <td>
                        <span class="badge mode-{{appointment.appointment_type|lower}}">{{appointment.appointment_type}}</span>
                    </td>
                    <td class="actions-cell">
                      <a href="{% url 'opd:medicine' id=appointment.id %}" class="btn-action" title="Prescribe Medicine">
                          <i class="fas fa-pills"></i>
                      </a>
                      <a href="{% url 'opd:confirmation_page' %}?section=appointment&id={{appointment.id}}" class="btn-action btn-danger" title="Cancel Appointment">
                          <i class="fas fa-trash-alt"></i>
                      </a>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="pagination">
        </div>
{% endblock content %}

{% block js %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const appointmentLink = document.querySelector("#appointment .nav-link");
    if (appointmentLink) {
      appointmentLink.classList.add("active");
    }

    const searchInput = document.getElementById('searchInput');
    if (window.location.search.includes('search_query')) {
      window.history.replaceState({}, document.title, window.location.pathname);
    }

    function performSearch() {
      const query = searchInput.value.trim();
      const url = "{% url 'opd:appointment' %}";
      if (query) {
        window.location.href = url + '?search_query=' + encodeURIComponent(query);
      } else {
        window.location.href = url;
      }
    }

    searchInput.addEventListener('keypress', function (event) {
      if (event.key === 'Enter') {
        event.preventDefault();
        performSearch();
      }
    });
  });
</script>
<script src="{% static 'scripts/online_appointment_request.js' %} "></script>
{% endblock js %}
